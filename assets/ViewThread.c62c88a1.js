import{_ as C,Z as E,a8 as b,aa as H,a1 as m,a2 as u,ad as s,d as o,a3 as c,ae as f,b2 as y,ai as d,F as S,b5 as R,J as v,af as x,aM as T,ak as I,ah as M,b3 as V,b4 as q}from"./index.56aced16.js";import{Q as D}from"./QTooltip.0e0f570b.js";import{Q}from"./QExpansionItem.2f2a2c84.js";import{u as N,g as k}from"./generateHeaders.891fe619.js";import{u as O}from"./auth_user_store.0a1df304.js";import{_ as A}from"./arrow_back.cc0c166d.js";import{_ as B}from"./reply_black.74556d4b.js";import{f as J}from"./index.e3cc403f.js";import"./position-engine.9dfbd25a.js";import"./selection.e4c60947.js";import"./QItemLabel.cffd16e9.js";import"./axios.af9b5afd.js";const{getSettings:j}=E(N()),{getAuthUserDetails:h}=E(O()),z={data(){return{response_data:"",all_docs:[],expanded_items:[],index_to_reply:null,reply_message:null,messages:[]}},computed:{encryptionEnabled(){var e;return(e=j.value)==null?void 0:e.api_encryption_enabled},title(){var e;return(e=this.messages[0])==null?void 0:e.title},receiverRole(){var e;return(e=this.messages[0])==null?void 0:e.receiver_role},to(){var e,a;return(a=(e=this.messages[0])==null?void 0:e.to)==null?void 0:a.id},threadId(){var e;return(e=this.messages[0])==null?void 0:e.thread_id}},mounted(){this.fetchMessageThread()},methods:{formateDateTime(e){if(!!e)return J(new Date(e),"yyy-MM-dd HH:mma")},async fetchMessageThread(){try{const e={thread_id:this.$route.params.id};let n=(await this.$api.get("/api/v1/communications/thread/",{headers:{...k()},params:e})).data;this.encryptionEnabled&&(n=JSON.parse(b(n)));const{message:p,success:_,results:i}=n;this.response_data=i,this.all_docs=this.response_data.docs,this.messages=this.all_docs}catch{}},handleExpanded(e){this.expanded_items.push(e)},handleCollapse(e){const a=this.expanded_items.findIndex(n=>n===e);this.expanded_items.splice(a,1)},showMessageOnHeader(e){return!this.expanded_items.includes(e)},showReplyHere(e){return this.index_to_reply===e},replyThread(e){this.index_to_reply=e},cancelReply(){this.index_to_reply=null,this.reply_message=null},async sendReply(){var e;try{const a={to:this.to,from:h.value.id,sender_role:h.value.role,receiver_role:this.receiverRole,title:this.title,body:this.reply_message,thread_id:this.threadId,message_id:(e=this.messages[this.index_to_reply])==null?void 0:e.id};this.encryptionEnabled&&(a=H(JSON.stringify(a)));let p=(await this.$api.post("/api/v1/communications/reply/",a,{headers:{...k()}})).data;this.encryptionEnabled&&(p=JSON.parse(b(p)));const{message:_,success:i,results:r}=p}catch{}},sender(e){return e.to.id===h||e.from.id===h?h.value.first_name:e.from.first_name}}},g=e=>(V("data-v-2fd1702e"),e=e(),q(),e),F={class:"communication-thread"},U={class:"q-my-sm flex justify-between"},L=g(()=>s("img",{src:A,style:{width:"25px"}},null,-1)),Z={class:"text-h6"},G={class:"text-capitalize"},K={class:""},P={class:"flex items-center full-width justify-between"},W={class:""},X={class:"text-capitalize"},Y={class:"text-capitalize"},$={class:"message-timestamp"},ee={class:"q-my-xs"},se={class:"q-px-sm"},te=g(()=>s("div",{class:"text-grey"},"Replies",-1)),ae={class:""},ie={class:"flex"},re={class:"col"},oe={class:""},de={class:"q-my-sm"},ne=g(()=>s("img",{src:B,style:{width:"25px"}},null,-1)),le={class:"reply-area"},ce={class:"flex q-mt-md justify-between"};function _e(e,a,n,p,_,i){return m(),u("div",F,[s("div",U,[o(f,{flat:"",dense:"",onClick:a[0]||(a[0]=r=>e.$router.go(-1))},{default:c(()=>[L]),_:1})]),s("div",Z,[y(" RE: "),s("span",G,d(i.title),1)]),s("div",K,[(m(!0),u(S,null,R(_.messages,(r,l)=>(m(),u("div",{class:"",key:l},[o(Q,{onShow:t=>i.handleExpanded(l),onHide:t=>i.handleCollapse(l),"dense-toggle":"","header-class":"text-body1 q-pa-none"},{header:c(()=>{var t,w;return[s("div",P,[s("div",W,[s("div",X,"From: "+d((t=r.from)==null?void 0:t.first_name),1),s("div",Y,"To: "+d((w=r.to)==null?void 0:w.first_name),1),v(s("div",{class:"text-subtitle2"},d(r.body),513),[[x,i.showMessageOnHeader(l)]])]),s("div",$,d(i.formateDateTime(r.createdAt)),1)])]}),default:c(()=>[s("div",ee,d(r.body),1),s("div",se,[te,(m(!0),u(S,null,R(r==null?void 0:r.replies,t=>(m(),u("div",{class:"",key:t==null?void 0:t.id},[s("div",ae,d(i.sender(t)),1),s("div",ie,[s("div",re,d(t==null?void 0:t.body),1),s("div",oe,d(i.formateDateTime(t.createdAt)),1)]),o(T,{class:"q-my-xs"})]))),128))]),s("div",de,[v(o(f,{flat:"",dense:"",onClick:t=>i.replyThread(l)},{default:c(()=>[ne,o(D,null,{default:c(()=>[y("Reply to this thread")]),_:1})]),_:2},1032,["onClick"]),[[x,l!=_.index_to_reply]])]),v(s("div",le,[s("form",{onSubmit:a[2]||(a[2]=I((...t)=>i.sendReply&&i.sendReply(...t),["prevent"]))},[o(M,{modelValue:_.reply_message,"onUpdate:modelValue":a[1]||(a[1]=t=>_.reply_message=t),outlined:"",type:"textarea",placeholder:"Enter reply here"},null,8,["modelValue"]),s("div",ce,[o(f,{unelevated:"","no-caps":"",dense:"",color:"red",onClick:i.cancelReply,style:{"min-width":"100px"}},{default:c(()=>[y("Cancel")]),_:1},8,["onClick"]),o(f,{unelevated:"","no-caps":"",color:"green",type:"submit",dense:"",style:{"min-width":"100px"}},{default:c(()=>[y("Send ")]),_:1})])],32)],512),[[x,i.showReplyHere(l)]])]),_:2},1032,["onShow","onHide"]),o(T)]))),128))])])}var Re=C(z,[["render",_e],["__scopeId","data-v-2fd1702e"]]);export{Re as default};
